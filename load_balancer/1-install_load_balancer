#!/usr/bin/env bash
# Install and configure HAProxy load balancer on Ubuntu 16.04

set -e

# Update package list and install haproxy
apt-get update
apt-get install -y haproxy

# Backup original haproxy configuration if not already backed up
if [ ! -f /etc/haproxy/haproxy.cfg.bak ]; then
    cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak
fi

# Write new haproxy configuration with roundrobin balancing to web servers
cat > /etc/haproxy/haproxy.cfg <<EOF
frontend http_front
    bind *:80
    default_backend http_back

backend http_back
    balance roundrobin
    server web01 52.91.19.144:80 check
    server web02 13.221.66.135:80 check
EOF

# Restart haproxy service to apply configuration
systemctl restart haproxy

# Enable haproxy to start at boot
systemctl enable haproxy
